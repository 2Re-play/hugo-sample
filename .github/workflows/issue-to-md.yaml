name: Issue to Markdown

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited, deleted]  # ì½”ë©˜íŠ¸ ìƒì„±, ìˆ˜ì •, ì‚­ì œ ì‹œ íŠ¸ë¦¬ê±°

permissions:
  contents: write  # ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ì¶”ê°€
  pages: write
  id-token: write

jobs:
  generate-markdown:
    runs-on: ubuntu-latest
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: docs ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸
        id: label-check
        run: |
          echo "LABEL_FOUND=false" >> $GITHUB_ENV
          echo "CATEGORY_PATH=" >> $GITHUB_ENV

          labels=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name')

          for label in $labels; do
            if [[ "$label" == "docs" ]]; then
              echo "LABEL_FOUND=true" >> $GITHUB_ENV
            elif [[ "$label" == */* ]]; then
              echo "CATEGORY_PATH=$label" >> $GITHUB_ENV
              break
            fi
          done

      - name: docs ë¼ë²¨ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
        if: env.LABEL_FOUND != 'true'
        run: |
          echo "docs ë¼ë²¨ì´ ì—†ìœ¼ë¯€ë¡œ ë³€í™˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤."
          exit 0

      - name: ê²½ë¡œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê²½ë¡œ posts ì‚¬ìš©
        run: |
          if [[ -z "$CATEGORY_PATH" ]]; then
            echo "CATEGORY_PATH=posts" >> $GITHUB_ENV
          fi

      - name: ì´ìŠˆ ë° ëŒ“ê¸€ì„ Markdown íŒŒì¼ë¡œ ì €ì¥
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIR_PATH="content/${CATEGORY_PATH}"
          mkdir -p "$DIR_PATH"
          FILE_PATH="$DIR_PATH/issue-${{ github.event.issue.number }}.md"

          # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (ìƒˆë¡œìš´ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì“°ê¸°)
          rm -f "$FILE_PATH"

          echo "---" >> "$FILE_PATH"
          echo "title: '${{ github.event.issue.title }}'" >> "$FILE_PATH"
          echo "date: '${{ github.event.issue.created_at }}'" >> "$FILE_PATH"
          echo "issue_number: ${{ github.event.issue.number }}" >> "$FILE_PATH"
          echo "author: '${{ github.event.issue.user.login }}'" >> "$FILE_PATH"
          echo "categories: ['${CATEGORY_PATH}']" >> "$FILE_PATH"
          echo "---" >> "$FILE_PATH"
          echo "" >> "$FILE_PATH"

          # ë³¸ë¬¸ ì²˜ë¦¬: ì½”ë“œë¸”ë¡/í‘œ ì´ìŠ¤ì¼€ì´í”„ + ê°œí–‰
          ISSUE_BODY=$(echo "${{ github.event.issue.body }}" | \
            sed 's/```/\\`\\`\\`/g' | \
            sed 's/|/\\|/g' | \
            sed ':a;N;$!ba;s/\n/\\n/g')

          echo "$ISSUE_BODY" | sed 's/\\n/\n\n/g' >> "$FILE_PATH"

          echo "" >> "$FILE_PATH"

          # ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
          COMMENTS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments)

          if [ "$(echo "$COMMENTS" | jq length)" -gt 0 ]; then
            echo "$COMMENTS" | jq -c '.[]' | while read -r comment; do
              AUTHOR=$(echo "$comment" | jq -r '.user.login')
              CREATED=$(echo "$comment" | jq -r '.created_at' | sed 's/T/ /; s/Z//')
              BODY=$(echo "$comment" | jq -r '.body' | \
                sed 's/```/\\`\\`\\`/g' | \
                sed 's/|/\\|/g' | \
                sed ':a;N;$!ba;s/\n/\\n/g')

              echo "" >> "$FILE_PATH"
              echo "{{% notice style=\"green\" title=\"ì½”ë©˜íŠ¸\" %}}" >> "$FILE_PATH"
              echo "ğŸ—£ ì‘ì„±ì : $AUTHOR" >> "$FILE_PATH"
              echo "ğŸ•’ ì‘ì„±ì¼ : $CREATED" >> "$FILE_PATH"
              echo "" >> "$FILE_PATH"
              echo "$BODY" | sed 's/\\n/\n\n/g' >> "$FILE_PATH"
              echo "{{% /notice %}}" >> "$FILE_PATH"
              echo "" >> "$FILE_PATH"
            done
          fi

      - name: Git ì„¤ì •
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git add content/
          if git diff --cached --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ“ Issue #${{ github.event.issue.number }} â†’ Markdown ì €ì¥ (ë³¸ë¬¸ + ëŒ“ê¸€)"
            git push
          fi
