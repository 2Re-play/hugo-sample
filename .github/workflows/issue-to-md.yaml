name: Issue to Markdown

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited, deleted]  # 코멘트 생성, 수정, 삭제 시 트리거

permissions:
  contents: write  # 레포지토리에 푸시할 수 있도록 권한 추가
  pages: write
  id-token: write

jobs:
  generate-markdown:
    runs-on: ubuntu-latest
    steps:
      - name: 레포지토리 체크아웃
        uses: actions/checkout@v4

      - name: docs 라벨이 있는지 확인
        id: label-check
        run: |
          echo "LABEL_FOUND=false" >> $GITHUB_ENV
          echo "CATEGORY_PATH=" >> $GITHUB_ENV

          labels=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name')

          for label in $labels; do
            if [[ "$label" == "docs" ]]; then
              echo "LABEL_FOUND=true" >> $GITHUB_ENV
            elif [[ "$label" == */* ]]; then
              echo "CATEGORY_PATH=$label" >> $GITHUB_ENV
              break
            fi
          done

      - name: docs 라벨이 없으면 종료
        if: env.LABEL_FOUND != 'true'
        run: |
          echo "docs 라벨이 없으므로 변환을 종료합니다."
          exit 0

      - name: 경로가 없으면 기본 경로 posts 사용
        run: |
          if [[ -z "$CATEGORY_PATH" ]]; then
            echo "CATEGORY_PATH=posts" >> $GITHUB_ENV
          fi

      - name: 이슈 및 댓글을 Markdown 파일로 저장
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIR_PATH="content/${CATEGORY_PATH}"
          mkdir -p "$DIR_PATH"
          FILE_PATH="$DIR_PATH/issue-${{ github.event.issue.number }}.md"

          # 기존 파일 삭제 (새로운 내용으로 덮어쓰기)
          rm -f "$FILE_PATH"

          echo "---" >> "$FILE_PATH"
          echo "title: '${{ github.event.issue.title }}'" >> "$FILE_PATH"
          echo "date: '${{ github.event.issue.created_at }}'" >> "$FILE_PATH"
          echo "issue_number: ${{ github.event.issue.number }}" >> "$FILE_PATH"
          echo "author: '${{ github.event.issue.user.login }}'" >> "$FILE_PATH"
          echo "categories: ['${CATEGORY_PATH}']" >> "$FILE_PATH"
          echo "---" >> "$FILE_PATH"
          echo "" >> "$FILE_PATH"
          
          # 본문에 개행 추가, 표나 코드 블록은 제외
          BODY=$(echo "${{ github.event.issue.body }}" | sed ':a;N;$!ba;s/\n\([^|`\n]\)/\n\n\1/g')
          echo "$BODY" >> "$FILE_PATH"

          echo "" >> "$FILE_PATH"

          # 댓글을 가져와서 추가
          COMMENTS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments)

          if [ "$(echo "$COMMENTS" | jq length)" -gt 0 ]; then
            # 각 코멘트마다 {{% notice %}}로 감싸기
            echo "$COMMENTS" | jq -r '.[] | 
              "{{% notice style=\"green\" title=\"코멘트\" %}}\n
          🗣 작성자 : \(.user.login)\n
          ⏰ 작성일 : \(.created_at | sub("T"; " ") | sub("Z"; ""))\n
              \(.body | 
                gsub("```"; "```") | 
                gsub("\n"; "\n\n") | 
                gsub("(^|\n)(\|[^\n]*)$"; "\1\2") # 표나 코드블록 끝에는 개행을 추가하지 않도록 처리
              )\n{{% /notice %}}"' >> "$FILE_PATH"
          fi

      - name: Git 설정
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: 변경 사항 커밋 및 푸시
        run: |
          git add content/
          git commit -m "📝 Issue #${{ github.event.issue.number }} → Markdown 저장 (코멘트 포함)"
          git push
